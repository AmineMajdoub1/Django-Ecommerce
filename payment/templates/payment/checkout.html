{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- ==================== PREMIUM CHECKOUT HEADER ==================== -->
<header class="premium-checkout-hero-section">
  <div class="hero-background">
    <div class="background-elements">
      <div class="floating-element el-1"></div>
      <div class="floating-element el-2"></div>
      <div class="floating-element el-3"></div>
      <div class="floating-element el-4"></div>
    </div>
    <div class="gradient-overlay"></div>
  </div>
  
  <div class="container">
    <div class="hero-content">
      <div class="brand-presentation">
        <div class="logo-glow"></div>
                        <h1 class="brand-title">
          <span class="title-main">Checkout</span>
          <span class="title-subtitle">FINALIZE YOUR ORDER</span>
        </h1>
        <div class="hero-divider">
          <div class="divider-line"></div>
          <div class="divider-dot"></div>
          <div class="divider-line"></div>
        </div>
        <p class="hero-tagline">Review your order and shipping details</p>
      </div>
    </div>
  </div>
</header>

<!-- ==================== CHECKOUT CONTENT ==================== -->
<section class="premium-checkout-section py-6">
  <div class="container">
    <div class="checkout-layout">
      <!-- Main Checkout Content -->
      <div class="checkout-content">
        <!-- Order Summary Card -->
        <div class="premium-card summary-card fade-in-up">
          <div class="card-header">
            <i class="bi bi-receipt"></i>
            <h3 class="card-title">Order Summary</h3>
          </div>
          <div class="card-body">
            <div class="order-items">
              {% for product in cart_products %}
              <div class="order-item">
                <div class="item-image">
                  <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-thumbnail">
                </div>
                <div class="item-details">
                  <h5 class="item-name">{{ product.name }}</h5>
                  
                  <!-- Display Selected Size -->
                  {% for key, item_data in cart_details.items %}
                    {% if key == product.id|slugify and item_data.selected_size %}
                    <div class="item-size">
                      <small>
                        <strong>Size: </strong>
                        {% if item_data.selected_size == 'custom' and item_data.custom_size %}
                          Custom: {{ item_data.custom_size }}
                        {% else %}
                          {{ item_data.selected_size }}
                        {% endif %}
                      </small>
                    </div>
                    {% endif %}
                  {% endfor %}
                  
                  <div class="item-meta">
                    <span class="item-quantity">
                      Quantity: 
                      {% for key, value in quantities.items %}
                        {% if key == product.id|slugify %}
                          {{ value }}
                        {% endif %}
                      {% endfor %}
                    </span>
                  </div>
                </div>
                <div class="item-price">
                  {% if product.is_sale %}
                  <div class="price-container">
                    <span class="price-sale">${{ product.sale_price }}</span>
                    <span class="price-original">${{ product.price }}</span>
                  </div>
                  {% else %}
                  <span class="price-current">${{ product.price }}</span>
                  {% endif %}
                </div>
              </div>
              {% if not forloop.last %}
              <div class="item-divider"></div>
              {% endif %}
              {% endfor %}
            </div>
            
            <div class="order-total">
              <div class="total-line">
                <span class="total-label">Order Total:</span>
                <span class="total-amount">${{ totals }}</span>
              </div>
            </div>
            
            <div class="card-actions">
              <a href="{% url 'cart_summary' %}" class="btn-premium-outline">
                <i class="bi bi-arrow-left"></i>
                Update Items
              </a>
            </div>
          </div>
        </div>

        <!-- Check if cart contains Gift Card -->
        {% with has_gift_card=False %}
          {% for product in cart_products %}
            {% if product.name == "Gift Card" or product.category.name == "Gift Card" %}
              {% with has_gift_card=True %}
        <!-- Gift Card Recipient Information -->
        <div class="premium-card summary-card fade-in-up">
          <div class="card-header">
            <i class="bi bi-gift"></i>
            <h3 class="card-title">GIFT CARD RECIPIENT</h3>
          </div>
          <div class="card-body">
            <div class="gift-card-notice">
              <p class="notice-text">
                <i class="bi bi-info-circle"></i>
                This gift card will be sent to the recipient's name you provide below.
              </p>
            </div>
          </div>
        </div>
              {% endwith %}
            {% endif %}
          {% endfor %}
        {% endwith %}

        <!-- Shipping Information Card -->
        <div class="premium-card summary-card fade-in-up">
          <div class="card-header">
            <i class="bi bi-truck"></i>
            <h3 class="card-title">
              {% for product in cart_products %}
                {% if product.name == "Gift Card" or product.category.name == "Gift Card" %}
                  Shipping & Recipient Information
                {% else %}
                  Shipping Information
                {% endif %}
              {% endfor %}
            </h3>
          </div>
          <div class="card-body">
            <form method="POST" action="{% url 'billing_info' %}" class="premium-form">
              {% csrf_token %}
              <div class="form-grid">
                <!-- Full Name Field - This will be used as recipient name for gift cards -->
                <div class="form-group">
                  <label for="{{ shipping_form.shipping_full_name.id_for_label }}" class="form-label">
                    {% for product in cart_products %}
                      {% if product.name == "Gift Card" or product.category.name == "Gift Card" %}
                        Recipient Full Name
                      {% else %}
                        {{ shipping_form.shipping_full_name.label }}
                      {% endif %}
                    {% endfor %}
                    <span class="required-asterisk">*</span>
                  </label>
                  <input 
                    type="text" 
                    id="{{ shipping_form.shipping_full_name.id_for_label }}" 
                    name="{{ shipping_form.shipping_full_name.name }}" 
                    class="form-control" 
                    placeholder="{% for product in cart_products %}{% if product.name == 'Gift Card' or product.category.name == 'Gift Card' %}Enter recipient's full name{% else %}Full Name{% endif %}{% endfor %}"
                    required
                    value="{{ shipping_form.shipping_full_name.value|default:'' }}"
                  >
                  {% if shipping_form.shipping_full_name.errors %}
                  <div class="form-errors">
                    {% for error in shipping_form.shipping_full_name.errors %}
                    <span class="error-text">{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                  {% for product in cart_products %}
                    {% if product.name == "Gift Card" or product.category.name == "Gift Card" %}
                    <small class="form-help">This name will appear on the gift card as the recipient</small>
                    {% endif %}
                  {% endfor %}
                </div>

                <!-- Rest of the shipping form fields -->
                {% for field in shipping_form %}
                  {% if field.name != 'shipping_full_name' %}
                  <div class="form-group {% if field.field.widget.input_type == 'checkbox' %}form-checkbox{% endif %}">
                    <label for="{{ field.id_for_label }}" class="form-label">
                      {{ field.label }}
                      {% if field.field.required %}
                      <span class="required-asterisk">*</span>
                      {% endif %}
                    </label>
                    {{ field }}
                    {% if field.help_text %}
                    <small class="form-help">{{ field.help_text }}</small>
                    {% endif %}
                    {% if field.errors %}
                    <div class="form-errors">
                      {% for error in field.errors %}
                      <span class="error-text">{{ error }}</span>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
              
              <div class="form-actions">
                <button type="submit" class="btn-premium full-width">
                  <i class="bi bi-arrow-right"></i>
                  Continue to Billing
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Order Progress Sidebar -->
      <div class="checkout-sidebar">
        <div class="premium-card progress-card fade-in-up">
          <div class="progress-header">
            <h4 class="progress-title">Order Progress</h4>
          </div>
          <div class="progress-steps">
            <div class="progress-step active">
              <div class="step-icon">
                <i class="bi bi-cart-check"></i>
              </div>
              <div class="step-content">
                <span class="step-label">Cart Review</span>
                <span class="step-status">Completed</span>
              </div>
            </div>
            <div class="progress-step active">
              <div class="step-icon">
                <i class="bi bi-truck"></i>
              </div>
              <div class="step-content">
                <span class="step-label">Shipping</span>
                <span class="step-status">Current Step</span>
              </div>
            </div>
            <div class="progress-step">
              <div class="step-icon">
                <i class="bi bi-credit-card"></i>
              </div>
              <div class="step-content">
                <span class="step-label">Payment</span>
                <span class="step-status">Next Step</span>
              </div>
            </div>
            <div class="progress-step">
              <div class="step-icon">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="step-content">
                <span class="step-label">Confirmation</span>
                <span class="step-status">Final Step</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Security Assurance -->
        <div class="premium-card security-card fade-in-up">
          <div class="security-header">
            <i class="bi bi-shield-check"></i>
            <h5>Secure Checkout</h5>
          </div>
          <div class="security-features">
            <div class="security-item">
              <i class="bi bi-lock-fill"></i>
              <span>SSL Encrypted</span>
            </div>
            <div class="security-item">
              <i class="bi bi-credit-card"></i>
              <span>Safe Payments</span>
            </div>
            <div class="security-item">
              <i class="bi bi-truck"></i>
              <span>Premium Shipping</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Link to external CSS -->
<link href="{% static 'css/checkout.css' %}" rel="stylesheet">
<style>
/* NUCLEAR OPTION - Force all text to be white */
.checkout-section * {
    color: #ffffff !important;
}

/* But keep form input text white (already set) */
.form-group input,
.form-group select,
.form-group textarea {
    color: #ffffff !important;
}

/* Keep button text appropriate */
.btn-premium {
    color: #2C2C2C !important;
}

.btn-premium-outline {
    color: #C6A664 !important;
}

.btn-premium-outline:hover {
    color: #2C2C2C !important;
}

/* Gift Card Notice Styles */
.gift-card-notice {
  background: rgba(198, 166, 100, 0.1);
  border: 1px solid rgba(198, 166, 100, 0.3);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}

.notice-text {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 0;
  font-size: 0.9rem;
  color: #C6A664 !important;
}

.notice-text i {
  color: #C6A664 !important;
  font-size: 1.1rem;
}
</style>

<script>
// Add floating elements to checkout section
document.addEventListener('DOMContentLoaded', function() {
    const checkoutSection = document.querySelector('.premium-checkout-section');
    if (checkoutSection) {
        const floatingContainer = document.createElement('div');
        floatingContainer.className = 'floating-elements';
        floatingContainer.innerHTML = `
            <div class="floating-element" style="width: 160px; height: 160px; top: 15%; right: -35px; animation-delay: 0s;"></div>
            <div class="floating-element" style="width: 110px; height: 110px; bottom: 25%; left: -20px; animation-delay: 2s;"></div>
            <div class="floating-element" style="width: 80px; height: 80px; top: 65%; right: 20%; animation-delay: 4s;"></div>
        `;
        checkoutSection.appendChild(floatingContainer);
    }
});
</script>

{% endblock %}